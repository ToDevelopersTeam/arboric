stages:
  - test
  - build

cargo_test:
  stage: test
  image: rust:1.37.0-stretch
  script:
    - cargo test

docker_build_develop:
  stage: build
  only:
    refs:
      - develop
    changes:
      - .gitlab-ci.yml
      - Cargo.*
      - src/**/*
      - etc/**/*
  services:
    - docker:19.03.1-dind
  image: docker:18.09.1
  script:
    - docker build
      -t registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:latest
      -t registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA
      .
    - docker push registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:latest
    - docker push registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA

docker_build_features:
  stage: build
  when: manual
  only:
    refs:
      - /^feature\/.*$/
    changes:
      - .gitlab-ci.yml
      - Cargo.*
      - src/**/*
      - etc/**/*
  services:
    - docker:19.03.1-dind
  image: docker:18.09.1
  script:
    - docker build
      -t registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:latest
      -t registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA
      .
    - docker push registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:latest
    - docker push registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA

docker_build_tags:
  stage: build
  only:
    - tags
  image: docker:18.09.1
  script:
    - docker build
      -t registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:latest
      -t registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_TAG
      .
    - docker push registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:latest
    - docker push registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_TAG
